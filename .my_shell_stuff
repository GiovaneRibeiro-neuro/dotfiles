## 
# ALIASES
##

test alias cfg > /dev/null 2>&1 || alias cfg='/usr/bin/git --git-dir=$HOME/.cfg/ --work-tree=$HOME'
test alias up > /dev/null 2>&1 || alias up='[[ `uname -a | grep "Ubuntu"`  ]] && ubuntu-update.sh || arch-update.sh'
test alias tmux > /dev/null 2>&1 || alias tmux='tmux -u2'
test alias clima > /dev/null 2>&1 || alias clima='curl v2.wttr.in'
test alias bye > /dev/null 2>&1 || alias bye='sudo shutdown -h now'

# Permite a extração do Dockerfile de uma determinada imagem
# exemplo de uso: dfimage -sV=1.36 nginx:latest
test alias dfimage > /dev/null 2>&1 || alias dfimage="docker run -v /var/run/docker.sock:/var/run/docker.sock --rm alpine/dfimage -sV=1.36"
test alias wiki >/dev/null 2>&1 || alias wiki='cd $HOME/workspace/wiki && git pull && obsidian && git add --all && git commit -am "wiki updates (notebook)" && git push'

##
# FUNCTIONS/APPS
##

# bottom - a better top
if command -v cargo >/dev/null 2>&1 > /dev/null; then
    if [ ! -f $HOME/.cargo/bin/btm ]; then
        cargo install -f --git https://github.com/ClementTsang/bottom bottom
    fi
    test alias oldtop >/dev/null 2>&1 || alias oldtop='/usr/bin/top'
    test alias top >/dev/null 2>&1 || alias top='btm --theme gruvbox'
fi

# Use lf to switch directories and bind it to ctrl-o
# Source: https://gist.github.com/LukeSmithxyz/e62f26e55ea8b0ed41a65912fbebbe52
lfcd () {
    
    if [ ! -f "$BIN_FOLDER/lf" ]; then
        BASEDIR=`pwd`
        cd $BIN_FOLDER

        file=lf-linux-amd64.tar.gz
        if [ "$OS" = "Darwin" ]; then
            file=lf-darwin-amd64.tar.gz
        fi 

        wget https://github.com/gokcehan/lf/releases/download/r14/$file
        tar -zxvf $file
        rm $file
        mkdir -p ~/.config/lf
        curl https://raw.githubusercontent.com/gokcehan/lf/master/etc/lfrc.example -o ~/.config/lf/lfrc
        cd $BASEDIR
    fi

    tmp="$(mktemp)"
    lf -last-dir-path="$tmp" "$@"
    if [ -f "$tmp" ]; then
        dir="$(cat "$tmp")"
        rm -f "$tmp"
        [ -d "$dir" ] && [ "$dir" != "$(pwd)" ] && cd "$dir"
    fi
}
if command -v zsh >/dev/null; then
    bindkey -s '^o' 'lfcd\n'
    autoload -Uz tetriscurses
    test alias tetris > /dev/null 2>&1 || alias tetris='tetriscurses'
fi

# fetch (using treefetch, and change it to a christmas tree when time comes)
fetch() {

    if [ "$OS" = "Darwin" ]; then

        if [ ! -f "$BIN_FOLDER/pfetch"  ]; then
            BASEDIR=`pwd`
            cd /tmp

            wget https://github.com/dylanaraps/pfetch/archive/master.zip
            unzip master.zip
            install pfetch-master/pfetch $BIN_FOLDER/
            ls -l $BIN_FOLDER/pfetch

            cd $BASEDIR
        fi

        pfetch
        exit 0
    fi

    if ! which treefetch &>/dev/null; then
        cargo install -f --git https://github.com/angelofallars/treefetch treefetch
    fi

    advent.sh # run the script to check if we are in advent
    advent_file=/tmp/advento.txt

    if [ ! -f $advent_file ]; then
        treefetch --bonsai
    else
        treefetch --xmas
    fi

}


gpg-enc() {
  local input_file="$1"
  local output_file="$2"
  local recipient

  if [[ -z "$input_file" || ! -f "$input_file" ]]; then
    echo "Uso: encrypt_file <arquivo> [arquivo_saida]"
    return 1
  fi

  output_file="${output_file:-${input_file}.gpg}"

  echo "Selecionando chave GPG..."
  gpg --list-keys --with-colons | awk -F: '/^uid:/ { print NR-1 ") " $10 }'
  read -p "Escolha o número da chave (acima): " idx
  recipient=$(gpg --list-keys --with-colons | awk -F: '/^uid:/ { print $10 }' | sed -n "$((idx+1))p")

  if [[ -z "$recipient" ]]; then
    echo "Chave inválida."
    return 1
  fi

  gpg -e -r "$recipient" -o "$output_file" "$input_file" && echo "✔ Encriptado com sucesso: $output_file"
}


gpg-dec() {
  local input_file="$1"
  local output_file="$2"

  if [[ -z "$input_file" || ! -f "$input_file" ]]; then
    echo "Uso: decrypt_file <arquivo.gpg> [arquivo_saida]"
    return 1
  fi

  output_file="${output_file:-${input_file%.gpg}}"

  gpg -d -o "$output_file" "$input_file" && echo "✔ Desencriptado com sucesso: $output_file"
}

# test later
#changeMac(){
#  local mac=$(openssl rand -hex 6 | sed 's/\(..\)/\1:/g; s/.$//')
#  sudo ifconfig en0 ether $mac
#  sudo ifconfig en0 down
#  sudo ifconfig en0 up
#  echo "Your new physical address is $mac"
#
#  #unlimited wi-fi?
#}

aws-login() {

    if ! which aws &>/dev/null; then
	    curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "/tmp/awscliv2.zip"
	    cd /tmp
	    unzip awscliv2.zip
	    sudo ./aws/install
	    cd $HOME
    fi
    
    SSO_SESSION_NAME=""
    [ -z $AWS_SSO_SESSION_NAME ] && SSO_SESSION_NAME="--sso-session $AWS_SSO_SESSION_NAME"

    PROFILE=default
    [ -n "$1" ] && PROFILE=$1

    if command -v aws >/dev/null 2>&1
    then
        aws sts get-caller-identity &> /dev/null
        EXIT_CODE="$?"
        if [ $EXIT_CODE != 0 ]; then
            aws sso login $SSO_SESSION_NAME
        fi

        aws configure export-credentials --profile $PROFILE --format env-no-export
    fi

}

##
# EXPORTS
##

# General exports
export NODE_ENV="development"
export PATH="$HOME/.cargo/bin:$PATH"
export EDITOR=vim
export TMPDIR=/tmp

##
# ALIAS
##
test alias info >/dev/null 2>&1 || alias info='informant --file $HOME/.cache/informant.dat'

flag_file="/tmp/flag_file"
if [ ! -f $flag_file ]
then
  command -v fetch >/dev/null 2>&1 && { fetch; echo ; touch $flag_file ; }
  # only works if informant is installed (installed via AUR)
  command -v informant > /dev/null 2>&1 && { info list --unread; echo; }
fi

#
export NVM_DIR="$HOME/.nvm"
[ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"  # This loads nvm
[ -s "$NVM_DIR/bash_completion" ] && \. "$NVM_DIR/bash_completion"  # This loads nvm bash_completion
